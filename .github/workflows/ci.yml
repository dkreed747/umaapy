name: CI

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint (black)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      - name: Install black
        run: |
          python -m pip install --upgrade pip
          pip install black==25.1.0
      - name: Check formatting
        run: |
          black --check --diff ./src ./tests
      - name: Lint failure guidance
        if: failure()
        run: |
          echo "::error title=Lint (black) failed::Run 'black ./src ./tests' locally and commit formatting fixes."
          echo "Contributor docs: ${{ github.server_url }}/${{ github.repository }}/blob/${{ github.sha }}/docs/usage/development.rst"
          echo "Agent context: ${{ github.server_url }}/${{ github.repository }}/blob/${{ github.sha }}/docs/AI_AGENT_PROMPT_CONTEXT.md"

  test-non-vendor:
    name: Test (pytest non-vendor)
    needs: [lint]
    runs-on: ubuntu-latest
    env:
      UMAAPY_AUTO_INIT: "0"
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      - name: Install package and test dependencies (RTI-free)
        run: |
          python -m pip install --upgrade pip
          pip install -e . --no-deps
          pip install "pytest>=8.4.1" "pytest-cov>=6.2.1"
      - name: Assert RTI package is not installed
        run: |
          python -c "import importlib.util,sys;rti_spec=importlib.util.find_spec('rti');connext_spec=importlib.util.find_spec('rti.connextdds') if rti_spec else None;print('rti spec:',rti_spec);print('rti.connextdds spec:',connext_spec);sys.exit(1 if connext_spec else 0)"
      - name: Run non-vendor tests
        run: |
          pytest -m "not integration_vendor"
      - name: Upload pytest reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pytest-non-vendor-reports
          path: |
            coverage.xml
            report.xml
            .pytest_cache/
      - name: Test failure guidance
        if: failure()
        run: |
          echo "::error title=Non-vendor pytest lane failed::Run 'pip install -e .[tests]' then 'pytest -m \"not integration_vendor\"' locally."
          echo "Contributor docs: ${{ github.server_url }}/${{ github.repository }}/blob/${{ github.sha }}/docs/usage/development.rst"
          echo "Agent context: ${{ github.server_url }}/${{ github.repository }}/blob/${{ github.sha }}/docs/AI_AGENT_PROMPT_CONTEXT.md"
